#!/usr/bin/python

import hal, time, sys, datetime, yaml, traceback
from autoclave import Config, Messages

##################################################################
# Control data

# Map stage name to ID and back
stage_name_id_map = dict(
    idle = 0, flush = 1, heat = 2, sterilize = 3, cool = 4)
stage_id_name_map = dict(zip(
    stage_name_id_map.values(), stage_name_id_map.keys()))
timed_stages = ('flush', 'sterilize')
valve_on_stages = ('flush')
max_burner_stages = ('flush') # Need PWM at 100% during flush

# Pin creation data
# (name, hal_type, hal_dir, save)
pin_data = [
    # Remote controls
    ('enable',			hal.HAL_BIT,	hal.HAL_IN,	True),
    ('start',			hal.HAL_BIT,	hal.HAL_IN,	False),
    # Process stage settings and status
    # - Current stage ID
    ('stage',			hal.HAL_S32,	hal.HAL_OUT,	False),
    # - Idle stage:  heat
    ('idle-temp-set',		hal.HAL_FLOAT,	hal.HAL_IN,	True),
    ('idle-temp',		hal.HAL_FLOAT,	hal.HAL_OUT,	False),
    ('idle-time',		hal.HAL_S32,	hal.HAL_OUT,	False),
    # - Flush stage: timer
    ('flush-time-set',		hal.HAL_S32,	hal.HAL_IN,	True),
    ('flush-time',		hal.HAL_S32,	hal.HAL_OUT,	False),
    # - Heat
    ('heat-temp-set',		hal.HAL_FLOAT,	hal.HAL_IN,	True),
    ('heat-temp',		hal.HAL_FLOAT,	hal.HAL_OUT,	False),
    ('heat-time',		hal.HAL_S32,	hal.HAL_OUT,	False),
    # - Sterilize
    ('ster-time-set',		hal.HAL_S32,	hal.HAL_IN,	True),
    ('ster-time',		hal.HAL_S32,	hal.HAL_OUT,	False),
    # - Cool
    ('cool-temp-set',		hal.HAL_FLOAT,	hal.HAL_IN,	True),
    ('cool-temp',		hal.HAL_FLOAT,	hal.HAL_OUT,	False),
    ('cool-time',		hal.HAL_S32,	hal.HAL_OUT,	False),
    # Controls out
    ('temp-set',		hal.HAL_FLOAT,	hal.HAL_OUT,	False),
    ('valve-on',		hal.HAL_BIT,	hal.HAL_OUT,	False),
    # Sensors in/limits out
    ('pressure',		hal.HAL_FLOAT,	hal.HAL_IN,	False),
    ('pressure-max',		hal.HAL_FLOAT,	hal.HAL_OUT,	True),
    ('temp-pot',		hal.HAL_FLOAT,	hal.HAL_IN,	False),
    ('temp-pot-max',		hal.HAL_FLOAT,	hal.HAL_OUT,	True),
    ('temp-burner',		hal.HAL_FLOAT,	hal.HAL_IN,	False),
    ('temp-burner-max',		hal.HAL_FLOAT,	hal.HAL_OUT,	True),
    # Other status
    ('time-elapsed',		hal.HAL_S32,	hal.HAL_OUT,	False),
    ('error',			hal.HAL_BIT,	hal.HAL_OUT,	False),
    ('estop',			hal.HAL_BIT,	hal.HAL_IN,	False),
    ('shutdown',		hal.HAL_BIT,	hal.HAL_IN,	False),
]

##################################################################
# Functions

def current_stage():
    return stage_id_name_map[h['stage']]

def stage_time_elapsed():
    s = current_stage()
    if s not in timed_stages:
        return False # Not a timed stage
    return (now - h['%s-time' % s]) > h['%s-time-set' % s]
        
def stage_temp_reached(cool=False):
    s = current_stage()
    if s in timed_stages:
        return False # Not a temp stage
    if not cool:
        return h['temp-pot'] >= h['%s-temp-set' % s]
    else:
        return h['temp-pot'] <= h['%s-temp-set' % s]

def enter_stage(stage_name, init=False):
    now = time.time()

    if not init:
        # Finalize previous stage
        name = current_stage()
        t = h['%s-time' % name] = (now - state['%s-time-start' % name])
        msg.info("Exiting '%s' stage after %d seconds" % (name, t))

        # If entering idle stage, finalize previous process
        if stage_name == 'idle':
            etime = now - state['time-elapsed-start']
            h['time-elapsed'] = 0
            state['time-elapsed-start'] = now
            h['start'] = False
            msg.info("Process ended; total elapsed time %d seconds" % etime)

    # If entering flush stage, initialize new process
    if stage_name == 'flush':
        h['time-elapsed'] = 0
        state['time-elapsed-start'] = now
        msg.info("Starting process")

    if stage_name in timed_stages:
        set_time = h['%s-time-set'] % stage_name
        msg.info("Entering '%s' stage for %d seconds at temperature %.1f"
                 % (stage_name, set_time, h['temp-set']))
    else:
        set_temp = (h['temp-pot-max'] if stage_name in max_burner_stages
                    else h['%s-temp-set' % stage_name])
        msg.info("Entering '%s' stage; set temperature %.1f"
                 % (stage_name, set_temp))
        h['temp-set'] = set_temp

    # Set stage ID pin
    state['stage'] = stage_name_id_map.get(stage_name)
    # Reset stage timer
    h['%s-time' % stage_name] = 0
    state['%s-time-start' % stage_name] = now
    # Set valve
    h['valve-on'] = (stage_name in valve_on_stages)
    return True

# Main loop function

def loop():
    time.sleep(0.1)

    # Exit
    if h['shutdown']:
        msg.info("Got shutdown signal = %s" % h['shutdown'])
        return False

    # Handle errors:
    #
    # These errors are just noted here; actual handling is in the HAL
    # file
    error = False

    # - E-Stop
    if h['estop']:  # Actual handling in HAL file
        if not state.get('error_seen',False):
            msg.warning("E-Stop")
        error = True

    # - Burner overheating
    if h['temp-burner'] > h['temp-burner-max']:
        if not state.get('error_seen',False):
            msg.warning("Burner overheating:  %.1f > %.1f" %
                        (h['temp-burner'], h['temp-burner-max']))
        error = True

    # - Autoclave overheating
    if h['temp-pot'] > h['temp-pot-max']:
        if not state.get('error_seen',False):
            msg.warning("Autoclave overheating:  %.1f > %.1f" %
                        (h['temp-pot'], h['temp-pot-max']))
        error = True

    # - Autoclave overpressure
    if h['pressure'] > h['pressure-max']:
        if not state.get('error_seen',False):
            msg.warning("Autoclave overpressure:  %.1f > %.1f" %
                        (h['pressure'], h['pressure-max']))
        error = True

    # - Enable signal cleared
    if not h['enable']:
        if not state.get('error_seen',False):
            msg.warning("Enable signal cleared")
        error = True

    # - Wrap up error processing
    if error:
        # Remember we saw an error and don't spew next round
        state['error_seen'] = True
        # Set error signal
        h['error'] = True
        return True
    else:
        if state.get('error_seen', False):
            msg.info("Error condition cleared; resuming")
        state['error_seen'] = False
        # Reset error signal
        h['error'] = False

    # Process state machine
    stage_name = current_stage()

    # - Enter idle state
    if not h['start'] and stage_name != 'idle':
        return enter_stage('idle')

    # - Idle -> steam flush
    if h['start'] and stage_name == 'idle':
        return enter_stage('flush')

    # - Flush -> heating
    if stage_name == 'flush' and stage_time_elapsed():
        return enter_stage('heat')

    # - Heating -> sterilization
    if stage_name == 'heat' and stage_temp_reached():
        return enter_stage('sterilize')

    # - Sterilization -> cooldown
    if stage_name == 'sterilize' and stage_time_elapsed():
        return enter_stage('cool')

    # - Cooldown -> idle
    if stage_name == 'cool' and stage_temp_reached(cool=True):
        return enter_stage('idle')

    # No state changes; update timers & temps and return
    now = time.time()
    h['time-elapsed'] = now - state['time-elapsed-start']
    h['%s-time' % stage_name] = now - state['%s-time-start' % stage_name]
    if stage_name not in timed_stages:
        h['%s-temp' % stage_name] = h['temp-pot']
    return True

##################################################################
# Init

# Console logging
msg = Messages('Autoclave control')

# Read saved settings
config = Config()
saved_state = config.read_state()

# Set up component
h = hal.component("autoclave-control")

# Init pins and pin values
for name, hal_type, hal_dir, save in pin_data:
    h.newpin(name, hal_type, hal_dir)
    if hal_dir == hal.HAL_IN:
        # input pins don't need init
        continue
    if save:
        # init from config file
        val = saved_state.get(name, 0)
        h[name] = val
        msg.info("Restored setting %s = %s" % (name,val))
    else:
        # init to zero
        h[name] = 0

# Dict to persist state across cycles
state = dict()

# Start in idle stage
enter_stage('idle', init=True)

# Mark the component as 'ready'
msg.info("Initialized")
h.ready()

##################################################################
# Run
try:
    # Run forever
    while loop():
        pass
except KeyboardInterrupt:
    msg.info("Caught interrupt")
except Exception as e:
    msg.info("Caught exception:  %s" % e)
    msg.info(traceback.format_exc())
finally:
    # Save settings
    msg.info("Saving settings")
    config.write_state(h, [d[0] for d in pin_data if d[3]])

    # Shut things off and exit
    msg.info("Exiting")
    h['temp-set'] = 0.0
    h['valve-on'] = False
    sys.exit(0)
